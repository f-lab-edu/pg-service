# ADR-0001: API 서버 대신 메시지 큐를 사용하는 이유

- **날짜:** 2025-09-10
- **상태:** 채택됨

## 맥락 (Context)

실시간 결제 데이터를 수신하는 아키텍처를 설계하는 과정에서, PG사로부터 받은 웹훅(Webhook)을 처리하는 두 가지 방식을 고려했습니다.

1.  **API 서버 직접 처리:** API 서버가 웹훅을 받은 후, 비즈니스 로직을 직접 처리하고 데이터베이스에 저장하는 방식.
2.  **메시지 큐 사용:** API 서버는 웹훅을 받아서 즉시 메시지 큐에 저장하고, 별도의 Consumer가 메시지를 가져와 비즈니스 로직을 처리하고 데이터베이스에 저장하는 방식.

단순한 API 서버 직접 처리 방식은 구현이 간단하지만, 아래와 같은 안정성 문제를 가질 수 있습니다.

- **트래픽 폭증:** 순간적으로 대량의 웹훅이 요청될 경우, API 서버와 데이터베이스의 부하가 급증하여 응답 지연 또는 실패를 유발하고, 이는 데이터 유실로 이어질 수 있습니다.
- **데이터베이스 장애:** 데이터베이스가 다운된 동안 수신되는 웹훅 데이터는 처리되지 못하고 유실됩니다.

## 결정 (Decision)

결제 데이터는 단 하나도 유실되어서는 안 되는 매우 중요한 정보이므로, 시스템 안정성을 최우선으로 고려하여 **메시지 큐(Message Queue)를 도입**하기로 결정합니다.

API 서버(`PaymentWebhookController`)는 웹훅을 수신하면 최소한의 검증만 거친 후 즉시 메시지 큐로 데이터를 발행합니다. 실제 데이터 처리 및 저장은 별도의 `PaymentEventConsumer`가 비동기적으로 수행합니다.

## 결과 (Consequences)

### 장점 (Pros)

- **안정성 및 데이터 유실 방지:** 트래픽이 폭증하거나 후속 처리 시스템(DB 등)에 장애가 발생하더라도, 요청은 일단 메시지 큐에 안전하게 보관되므로 데이터가 유실되지 않습니다.
- **부하 분산:** 웹훅 요청을 일단 큐에 쌓아두고 순차적으로 처리하므로, 시스템이 처리할 수 있는 만큼의 부하를 유지할 수 있습니다. (Backpressure 조절)
- **느슨한 결합 (Decoupling):** 웹훅을 수신하는 시스템과 실제 데이터를 처리하는 시스템이 분리되어, 서로의 상태에 영향을 주지 않고 독립적으로 확장하거나 수정할 수 있습니다.

### 단점 (Cons)

- **아키텍처 복잡성 증가:** 메시지 큐라는 컴포넌트가 하나 더 추가되어야 하므로, 전체 시스템의 복잡도가 소폭 상승합니다.
- **운영 및 관리 포인트 증가:** 메시지 큐 자체에 대한 모니터링 및 관리 노력이 필요합니다.
